#!/usr/bin/env node
// -*- js -*-

var fs = require('fs'),
    daemon = require('daemon'),
    winston = require('winston'),
    express = require('express'),
    cookieParser = require('cookie-parser'),
    morgan = require('morgan'),
    session = require('express-session'),
    droonga = require('express-droonga'),
    responseTime = require('response-time'),
    http = require('http'),
    options = require('commander');

var version = require('../package.json').version;

intOption = function(newValue, oldValue) {
  return parseInt(newValue);
}

pluginsOption = function(newValue, oldValue) {
  return newValue.split(/\s*,\s*/).map(function (plugin) {
    return require(plugin);
  });
}

options
  .version(version)
  .option('--port <port>', 'Port number', intOption, 13000)
  .option('--receive-host-name <name>',
          'Host name of the protocol adapter. ' +
            'It must be resolvable by Droonga engine.',
          '127.0.0.1')
  .option('--droonga-engine-host-name <name>', 'Host name of Droonga engine',
          '127.0.0.1')
  .option('--droonga-engine-port <port>', 'Port number of Droonga engine',
          intOption, 10031)
  .option('--default-dataset <dataset>', 'The default dataset',
          'Droonga')
  .option('--tag <tag>', 'The tag',
          'droonga')
  .option('--access-log-file <file>',
          'Output access logs to <file>. ' +
            'You can use "-" as <file> to output to the standard output.')
  .option('--system-log-file <file>',
          'Output system logs to <file>. ' +
            'You can use "-" as <file> to output to the standard output.')
  .option('--cache-size <size>', 'The max number of cached requests',
          intOption, 100)
  .option('--enable-trust-proxy',
          'Enable "trust proxy" configuration. It is required when you run droonga-http-server behind a reverse proxy.')
  .option('--plugins <plugin1,plugin2,...>',
          'Use specified plugins.',
          pluginsOption,
          [
            droonga.API_REST,
            droonga.API_GROONGA,
            droonga.API_DROONGA
          ])
  .option('--daemon', 'Run as a daemon.')
  .option('--pid-file <pid-file>', 'Output PID to <pid-file>.')
  .parse(process.argv);

if (options.daemon) {
  daemon();
}

var logger;
if (options.systemLogFile) {
  logger = new winston.Logger({
    transports: [
      new winston.transports.File({
        filename: options.systemLogFile,
        json: false
      })
    ]
  });
} else {
  var transports = [];
  if (!options.daemon) {
    transports.push(new winston.transports.Console());
  }
  logger = new winston.Logger({
    transports: transports
  });
}

if (options.pidFile) {
  var fd = fs.openSync(options.pidFile, 'w', 0644);
  fs.writeSync(fd, process.pid.toString());
}

var application = express();
var server = http.createServer(application);

application.set('json spaces', 1);
var env = process.env.NODE_ENV || 'development';
if (env == 'production') {
  application.set('json spaces', -1); // disable pretty print!
}

var MemoryStore = session.MemoryStore;
var sessionStore = new MemoryStore();

if (options.enableTrustProxy) {
  application.enable('trust proxy');
}

if (options.accessLogFile) {
  var accessLogStream;
  if (options.accessLogFile == '-') {
    accessLogStream = process.stdout;
  } else {
    var accessLogStreamOptions = {
      flags: 'a',
      mode: 0644
    };
    accessLogStream = fs.createWriteStream(options.accessLogFile,
                                           accessLogStreamOptions);
  }
  var accessLogOptions = {
    stream: accessLogStream
  };
  application.use(morgan(accessLogOptions));
}
application.use(cookieParser('secret key'));
application.use(session({
  secret: 'secret key',
  store:  sessionStore
}));
application.use(responseTime());
if (options.cacheSize > 0) {
  var cacheMiddlewareRules = [
    { regex: /^\// }
  ];
  if (droonga.Cache) {
    var cache = new droonga.Cache({
      size: options.cacheSize,
    });
    application.use("/statistics/cache",
                    droonga.middleware.cacheStatistics(cache));
    application.use(droonga.middleware.cache(cache, {
      rules: cacheMiddlewareRules,
      logger: logger
    }));
  } else if (droonga.cache) {
    // TODO: Remove me when express-droonga 1.0.2 is released and
    // droonga-http-server requires express-droonga 1.0.2 or later.
    application.use(droonga.cache({
      size: options.cacheSize,
      rules: cacheMiddlewareRules,
    }));
  }
}

application.droonga({
  prefix: '',
  logger: logger,
  defaultDataset: options.defaultDataset,
  tag: options.tag,
  server: server,
  sessionStore: sessionStore, // this is required to share session information HTTP APIs
  receiveHostName: options.receiveHostName,
  hostName: options.droongaEngineHostName,
  port: options.droongaEnginePort,
  plugins: options.plugins
});

server.listen(options.port);

function shutdown() {
  server.close();
  if (options.pidFile && fs.existsSync(options.pidFile)) {
    fs.unlinkSync(options.pidFile);
  }
}

process.on('SIGINT', function() {
  shutdown();
});

process.on('SIGTERM', function() {
  shutdown();
});
